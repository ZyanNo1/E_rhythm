<!DOCTYPE html>
<html lang="zh">

<head>
    <!-- 基本元数据设置 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="../font/iconfont.css">
    <link rel="stylesheet" href="../css/user_home.css">
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/stylesheet.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            display: flex;
            overflow-x: hidden; /* 防止水平滚动条 */
        }
        
        .space{
            background-color: #367446;
            z-index: 10;
            position: relative;
            margin: auto;
            width: 100vh;
            height: 100px;
        }
        .sidebar {
            width: 100px; /* 侧边栏初始宽度 */
            height: 100vh;
            background-color: #333;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out; /* 平滑动画效果 */
            z-index: 1000; /* 确保侧边栏在主内容区域之上 */
        }

        .sidebar:hover {
            width: 150px; /* 鼠标悬停时侧边栏宽度增加到170像素 */
            background-color: #444; /* 鼠标悬停时改变背景色（可选） */
        }

        .main-content {
            margin-left: 420px; /* 确保主内容区域从侧边栏的最大宽度开始留出空间 */
            margin-right: 420px;
            margin-top: 20px;
            padding: 40px;
            overflow-y: auto; /* 允许正文内容垂直滚动 */
            /* flex-grow: 1; 占据剩余空间 */
            height: 900px; /* 占据整个视口高度 */
            /* 可以根据需要添加其他样式 */
            background-color: rgb(255, 255, 255);
        }

        /* 可选：为侧边栏链接添加样式 */
        .sidebar a {
            padding: 12px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
            text-align: center;
            transition: color 0.3s ease-in-out; /* 平滑文字颜色变化（可选） */
        }

        .sidebar a:hover {
            background-color: #575757;
            color: #f0f0f0; /* 鼠标悬停在链接上时改变文字颜色（可选） */
        }

        .content-wrapper {
            flex-grow: 1; /* 占据剩余空间 */
            display:flex;
            flex-direction: column; /* 垂直排列子元素 */
            overflow: hidden; /* 隐藏滚动条（如果需要的话，可以在内部元素上设置滚动） */
            background-color: rgba(255, 255, 255, 0.5); /* 半透明背景色 */
            background-image: url('../img/b.jpg');
            background-size: cover; /* 让背景图片覆盖整个区域 */
            background-repeat: no-repeat; /* 防止背景图片重复 */
            background-position: center; /* 将背景图片居中 */
        }

        .top-navbar {
            background-color: #ffffffb9;;
            color: rgb(0, 0, 0); 
            padding: 10px 20px;
            display: grid;  
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr; /* 将容器分为12等份 */  
            align-items: center; /* 垂直居中 */
        }
        
        .nav-right {  
            grid-column: 10 / 12; /* 右边的标签占据第3列（可以调整为更右的列，根据需要） */  
            display: flex;  
            justify-content: flex-start; /* 如果需要在列内左对齐标签，否则可以删除此行 */  
            gap: 15px; /* 标签之间的间距 */  
            font-size: 25px;
        }  

        .nav-right a {  
            color: white;  
            text-decoration: none;  
            padding: 10px 22px;  
            transition: transform 0.3s ease, background-color 0.3s ease;  
            font-family: 'youshebiaotihei';
            color: rgb(0, 0, 0); 
            text-decoration: none; /* 去除下划线 */
            margin-left: 20px; /* 链接之间的间距 */
            padding: 5px 10px; /* 链接内边距 */
            border-radius: 5px; /* 圆角边框 */
            transition: background-color 0.3s; /* 背景颜色过渡效果 */
            justify-self: center; /* 在列中居中 */  
            display: flex;
        }  
 
        .nav-right a:hover {
            background-color: rgba(255, 255, 255, 0.1); /* 悬停时背景变亮 */
        }
 
        .main-content {
        
            /* flex-grow: 1; */
            overflow-y: auto; /* 允许正文内容垂直滚动 */
            padding: 20px;
            box-sizing: border-box; /* 包括内边距和边框在内的元素总宽度和高度 */
            background-color: #fdfdfdd0;
            position: relative;
        }

        .profile-header {
            position: relative;
            height: 300px;
            background-size: cover;
        }
        
        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info {
            width: 300px;
            height: 80px;
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 20px;
            color: #000000;
            background-color:rgb(231, 225, 221);
            font-family: 'youshebiaotihei';
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .username {
            display: inline-block;
            vertical-align: middle;
        }
        
        .profile-content {
            display: flex;
            padding: 10px;
            height: 500px;
            background-image: url('../img/5.jpg');
            background-size: cover; /* 让背景图片覆盖整个区域 */
            font-family: 'youshebiaotihei';
            font-size: large;
        }
        
        .profile-left, .profile-right {
            flex: 1;
            padding: 10px;
        }
        
        .profile-details {
            list-style-type: none;
            padding: 0;
        }
        
        .profile-details li {
            margin-bottom: 10px;
        }
        
        .profile-details span {
            font-weight: bold;
        }
        
        .introduction-wrapper {
            position: relative;
        }
        
        .introduction-input {
            width: 100%;
            height: 100px;
            margin-top: 10px;
            resize: none;
            background-color: #f9f3e6;
            font-family: 'youshebiaotihei';
        }
        
        .edit-button, .save-button {
            position: absolute;
            right: 0;
            padding: 8px 18px; 
            font-size: 16px; 
            font-family: 'youshebiaotihei';
            margin-top: 10px;
            color: #000000; 
            background-color: #d2b983; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s ease;
        }
        
        .save-button {
            display: none; 
        }

    </style>
</head>

<body class="content" id="content">
    <div class="sidebar">
        <!-- 侧边栏导航链接 -->
        <a href="/home"><img src="../img/logo.png "style="border-radius: 15px;width: 40px;height: 40px;" alt="产品logo"></a>
        <a href="/write">创作</a>
        <a href="/cowork">论坛</a>
        <a href="/collection">收藏夹</a>
        <a href="/pediaHome">百科</a>
        <a href="http://127.0.0.1:8080">数据台</a>
        <!-- 用户头像显示，根据登录状态显示不同链接 -->
        <% if(user && user.username){ %>
            <a href="/user/info"><img src="<%= data[0].avatar || '../img/用户.jpg' %>" style="border-radius: 15px;width: 40px;height: 40px;" alt="用户"></a>
        <% }else{ %>
            <a href="/user/login"><img src="../img/用户.jpg" style="border-radius: 15px;width: 40px;height: 40px;" alt="用户"></a>
        <% } %>
    </div>

    <div class="content-wrapper">
        <div class="top-navbar">
            <div class="nav-right">
                <a><%= user.username %></a> 
                <a href="/user/logout">注销</a>  

                <!-- 这里我根据用户的信息重新加载了右上角的头像 -->
                <a href="/user/info"><img src="<%= data[0].avatar || '../img/用户.jpg' %>" style="border-radius: 15px;width: 40px;height: 40px;" alt="用户"></a>
            </div>
        </div>
        <div class="main-content">
            <div>
                <div class="profile-header">
                    <img src="../img/6.jpg" alt="Background" class="background-image">
                    <div class="profile-info">
                        <!-- 我这里也做了修改-->
                        <img id="avatar-img" src="<%= data[0].avatar || '../img/用户.jpg' %>" alt="Avatar" class="avatar" style="cursor:pointer;">
                        <input type="file" id="avatar-input" accept="image/*" style="display:none;">
                        <h2 class="username"><%= user.username %></h2>
                    </div>
                </div>
                <br><br>
                <div class="profile-content">
                    <div class="profile-left">
                        <h3>个人介绍</h3>
                        <div class="introduction-wrapper">
                            <p class="introduction"><%= data[0].introduction%>
                            </p>
                            <button class="edit-button" onclick="toggleEditMode()">编辑</button>
                            <textarea class="introduction-input" hidden></textarea>
                            <button class="save-button" hidden onclick="saveIntroduction()">保存</button>
                        </div>
                    </div>
                    <script> console.log('<%= JSON.stringify(data) %>'); // 在浏览器控制台输出 `data` </script>
                    <div class="profile-right">
                        <ul class="profile-details">
                            <% var regd=data[0].regtime.toISOString().split('T')[0];%>
                            <li><span>用户ID:</span><%= user.uid %></li><br>
                            <li><span>用户类型:</span> 普通用户 </li><br>
                            <li><span>注册日期:</span> <%= regd%></li><br>
                            <li><span>发文数量:</span> <%= data[0].post_num%></li><br>
                            <li><span>社区贡献:</span> <%= data[0].contribution%></li><br>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script> 
    function toggleEditMode() { 
        const introParagraph = document.querySelector('.introduction'); 
        const introTextarea = document.querySelector('.introduction-input'); 
        const editButton = document.querySelector('.edit-button'); 
        const saveButton = document.querySelector('.save-button'); 

        if (introTextarea.style.display === 'none') { // 进入编辑模式 
            introTextarea.style.display = 'block'; 
            saveButton.style.display = 'inline-block'; 
            editButton.style.display = 'none'; 
            introParagraph.style.display = 'none'; 
            introTextarea.value = introParagraph.textContent.trim(); 
        } else { // 退出编辑模式 
            introTextarea.style.display = 'none'; 
            saveButton.style.display = 'none'; 
            editButton.style.display = 'inline-block'; 
            introParagraph.style.display = 'block'; 
        } 
    }

        function saveIntroduction() { 
            const introduction = document.querySelector('.introduction-input').value;
            const userId = '<%= user.uid %>'; 
            fetch('/user/updateIntroduction', {
                 method: 'POST', 
                 headers: { 'Content-Type': 'application/json' }, 
                 body: JSON.stringify({ user_id: userId, introduction: introduction }) 
                 }).then(response => response.json()) .then(data => { 
                    if (data.success) { 
                        document.querySelector('.introduction').textContent = introduction; 
                        toggleEditMode(); alert('简介更新成功'); 
                    } 
                    else { 
                        alert('更新失败'); 
                    }
            });   
        } 
    </script>
    <script>
    document.getElementById('avatar-img').onclick = function() {
        document.getElementById('avatar-input').click();
    };

    document.getElementById('avatar-input').onchange = function() {
        const file = this.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('avatar', file);
        formData.append('user_id', '<%= user.uid %>');
        fetch('/user/uploadAvatar', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.avatarUrl) {
                document.getElementById('avatar-img').src = data.avatarUrl + '?t=' + Date.now();
                const topAvatar = document.querySelector('.nav-right img');
                if (topAvatar) {
                    topAvatar.src = data.avatarUrl + '?t=' + Date.now();
                }
                const sidebarAvatar = document.querySelector('.sidebar img[alt="用户"]');
            if (sidebarAvatar) {
                sidebarAvatar.src = data.avatarUrl + '?t=' + Date.now();
            }
                alert('头像更新成功');
            } else {
                alert('头像更新失败');
            }
        })
        .catch(() => alert('头像上传出错'));
    };
    </script>
</body>

</html>